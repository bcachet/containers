FROM registry.fedoraproject.org/fedora-toolbox:40

RUN dnf install -y \
            curl \
            git \
            direnv \
            eza \
            fd-find \
            file \
            fzf \
            jq \
            just \
            neovim \
            opensc \
            openssh-clients \
            procps-ng \
            ripgrep \
            yq \
        --nodocs --setopt install_weak_deps=False \
    && dnf clean all -y

RUN dnf groupinstall -y 'Development Tools' \
        --nodocs --setopt install_weak_deps=False \
    && dnf clean all -y

# Install final user
RUN useradd -m -s /bin/bash -u 1000 bertrand \
&& echo 'bertrand ALL=(ALL) NOPASSWD:ALL' >>/etc/sudoers
USER bertrand

# Install Brew
RUN curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh | bash
ENV PATH=$PATH:/home/linuxbrew/.linuxbrew/bin/

RUN brew \
        install \
            bottom \
            chezmoi \
            lazygit \
            starship \
    || true
RUN mkdir -p ~/.ssh && ssh-keyscan github.com >> ~/.ssh/known_hosts

RUN --mount=type=ssh,uid=1000,gid=1000 <<EOF
mkdir -p ~/.local/share/chezmoi && mkdir -p ~/.config/chezmoi
chezmoi init --depth=1 --apply --no-tty --no-pager --progress=true git@github.com:bcachet/dotfiles.git
EOF
